<!DOCTYPE html>
<html>

<head>
    <%-include head.ejs%>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect();
        var i, username, j = 0, myscore = 0, otherscore = 0, finalresults, ti, user_id;

        socket.on('updatechat', function (username, data, id) {
            $("#conversation").fadeIn();
            $('#conversation').append('<br>' + data + '<br>');
            user_id = id;

        });

        socket.on('game', function (data) {
            $('#realtime').append('<b>' + data + '<br>');
        });

        function doFunction() {
            $(".rules").fadeIn();
        }

        socket.on('sendQuestions', function (data) {
            $(".intermediate").fadeOut('slow');

            doFunction();

            i = 0;

            ti = setInterval(function () {
                $(".rules").fadeOut();
                $(".started").fadeIn('slow');
                $(".loading-page").fadeIn('slow');
                $("#realresults").fadeIn('slow');

                if (i < 4) {
                    j = 0; j++;
                    $('#qst').text(data.questions[i].question);
                    $('#btn1').attr('value', 0).text(data.questions[i].choices[0]);
                    $('#btn2').attr('value', 1).text(data.questions[i].choices[1]);
                    $('#btn3').attr('value', 2).text(data.questions[i].choices[2]);
                    $('#btn4').attr('value', 3).text(data.questions[i].choices[3]);


                    //timer
                    $(document).ready(function () {

                        var counter = 0;
                        var c = 1;
                        var k = setInterval(function () {
                            $(".loading-page .counter h3").html(c + "sec");
                            $(".loading-page .counter hr").css("width", (c * 10) + "%");

                            counter++;
                            c++;

                            if (counter == 10) {
                                clearInterval(k);

                            }
                        }, 1000);
                    });
                    //timer

                    $("#realtime button").removeClass("btn disabled");
                    $("#realtime button").prop('disabled', false);
                    $("#realtime button").click(function () {
                        $("#realtime button").addClass("btn disabled");
                        $("#realtime button").prop('disabled', true);
                        var givenAns = this.value;
                        var correctAns = data.questions[i - 1].correctAnswer;
                        var response = (givenAns == correctAns);
                        if (response) {
                            if (j == 1) {
                                socket.emit('result', username, user_id);
                                console.log("correct ans");
                                console.log(username);
                                console.log("value of inner j: " + j)
                                $('.current_res_c').fadeIn().delay(800).fadeOut(); j++;
                            }

                        } else {
                            if (j == 1) {
                                $('.current_res_w').fadeIn().delay(800).fadeOut(); j++;
                            }
                        }
                    });


                } i++;

                if (i == 5) {
                    clearInterval(ti);
                    $(".started").fadeOut('slow');
                    $(".loading-page").fadeOut();
                    $("#finalresult_show").fadeIn('slow');
                }


            }, 5000);



        });

        socket.on('viewresult', function (usr) {
            if (usr == username) {
                myscore += 1;
                $("#myresult").text(myscore);

            }
            else {
                otherscore += 1;
                $("#otherresult").text(otherscore);
            }

            if (myscore > otherscore) {
                $("#finalresult").text("You Win!");
                //finalresults=0;
                //console.log("final winner");
            } else if (myscore < otherscore) {
                $("#finalresult").text("You Lose..");
                //finalresults=1;
                //console.log("final loser");
            } else {
                //finalresults=2;
                $("#finalresult").text("Tie!");
            }

        });


        $(document).ready(function () {
            $('#btnJoin').click(function () {
                $(".just_start").fadeOut();
                username = $("#input_user").val();
                console.log(username);
                if (username != '') {
                    socket.emit('addClient', username);
                } else {
                    alert("USERNAME PLEASE!");
                    window.location = "http://localhost:4444";
                }
            });
        });



    </script>
</head>
<body>
    <div id="realresults" style="display: none;">
        <div>My Score<div id="myresult">0</div></div>
        <div>My Score<div id="otherresult">0</div></div>
            <div class="col-md-6" style="text-align:right;">
                <h4>Opponent Score<b>
                        <div id="otherresult">0</div>
                    </b></h4>
            </div>
        </div>
    </div>
    <!-- 매칭후 대기화면 -->
    <div class="rules" style="display: none;">
        <div class="logo">국방퀴즈</div>
        <div class="title">
            대결 상대를 찾았습니다!
        </div>
        <div class="subTitle">
            게임이 5초 후에 시작됩니다...
        </div>
        <div class="panel">
            <h3 class="title">규칙</h3>
            <div class="desc">
                <p>1. 각 퀴즈는 <strong>10초</strong>간 진행됩니다.</p>
                <p>2. 답을 누르신 후, <strong style="color: var(--red);">변경이 불가능</strong>합니다.</p>
                <p>3. 총 <strong>10개</strong>의 퀴즈로 구성되었으며, 하나의 퀴즈에 <strong>4개</strong>의 답변이 제공됩니다.</p>
            </div>
        </div>
    </div>
    <div class="row started" id="realtime" style="display: none;">
        <div class="question">
            <div class="row text-center">
                <div class="col-md-12">
                    <h2>
                        <br>
                        <p id="qst"></p>
                    </h2>
                </div>
            </div>
        </div>

        <div class="choices">
            <div class="row">
                <div class="col-md-4 col-sm-6 col-md-offset-3">
                    <button id="btn1" value=""></button>
                </div>
                <div class="col-md-3  col-sm-6">
                    <button id="btn2" value=""></button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 col-sm-6 col-md-offset-3">
                    <button id="btn3" value=""></button>
                </div>
                <div class="col-md-3 col-sm-6">
                    <button id="btn4" value=""></button>
                </div>
            </div>
        </div>
    </div>
    <!-- 문제 맞췄을 때 팝업 -->
    <div class="current_res_c text-center" style="display: none;">
        <div class='alert' role='alert'>정답입니다.</div>
    </div>
    <!-- 문제 틀렸을 때 팝업 -->
    <div class="current_res_w text-center" style="display: none;">
        <div class='alert' role='alert'>오답입니다.</div>
    </div>

    <div class="intermediate">
        <div id="conversation" style="display: none;">
            <div class="loading">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
    <!-- 시작전, 화면 -->
    <div class="just_start">
        <a class="goHome" href="/" title="홈으로">
            <span></span>
            <span></span>
        </a>
        <div class="content">
            <div class="logo">국방퀴즈</div>
            <div class="title">경쟁전</div>
            <div class="subTitle">경쟁전에 참여하고 포인트를 모아보세요!</div>
            <input type="hidden" id="input_user" value="<%=udata.uid%>"><br>
            <button class="btn btn-lg btn-start" id='btnJoin'>게임 시작</button>
        </div>
    </div>
    <div id="view_result" style="display: none;"></div>
    <div class="loading-page" style="display: none;">
        <div class="counter">
            <h3>0sec</h3>
            <hr>
        </div>
    </div>
    <!--Timer-->
    <div id="finalresult_show" style="display: none;">
        <div id="finalresult"></div>
        <a class="btn btn-blue" href="/quiz-rank">Play Again</a>
    </div>
</body>
<script>
    document.addEventListener('scroll', () => {
        let y = window.scrollY;
        if (y > 120) {
            $('.goHome').css("background-color", "rgba(21,21,22,.5)");
        } else {
            $('.goHome').css("background-color", "rgba(0,0,0,0)");
        }
    });
</script>
</html>